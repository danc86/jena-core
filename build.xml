<!-- tested using ant 1.5 -->
<project name="jena" default="main" basedir=".">

    <property name="Name"            value="Jena"/>
    <property name="name"            value="jena"/>
    
    <!-- The major and minor version numbers  -->
    <property name="version-major"   value="2"/>
    <property name="version-minor"   value="1"/>
    <!-- e.g. -beta1, or empty string for stable releases -->
    <property name="version-status"  value="-dev-4"/>
    <property name="version"
         value="${version-major}.${version-minor}${version-status}"/>

    <property name="dist.name"       value="${Name}-${version}"/>
    
    <property name="web.site"        value="http://jena.sourceforge.net/" />
  
    <property name="debug"           value="true"/>
    <property name="debuglevel"      value="source,lines"/>
    <property name="deprecation"     value="false"/>
    <property name="optimize"        value="true"/>

    <property name="orig-src.dir"    value="src"/>
    <property name="src.dir"         value="bldsrc"/>
    <property name="classes.dir"     value="bldbin"/>
    <property name="dist.root"       value="dist"/>
    <property name="dist.dir"        value="${dist.root}/${dist.name}"/>
    <property name="lib.dir"         value="lib"/>

    <property name="doc.dir"         value="doc"/>
    <property name="vocab.dir"       value="vocabularies"/>
    <property name="javadoc.dir"     value="doc/javadoc"/>
    <property name="etc.dir"         value="etc"/>
    <property name="test.dir"        value="testing"/>
    <property name="tools.dir"        value="tools"/>

    <property name="jarfile"         value="${name}.jar"/>
    <property name="srczipfile"      value="${name}-src.zip"/>

    <!-- Oh dear - a fixed path -->
    <property name="javacchome"      value="c:/home/afs/sys/javacc-2.1"/>

    <!-- Sub-system specific -->
    <property name="rdql.root" value="src/com/hp/hpl/jena/rdql"/>

    <!-- vocabulary generation -->
    <property name="vocab.java"       value="src/com/hp/hpl/jena/vocabulary" />
	<property name="vocab.tool"      value="jena.schemagen" />
	<property name="vocab.template"  value="vocabularies/jenavocab.rdf" />

    <path id="classpath">
      <fileset dir="${lib.dir}" includes="*.jar" excludes="${jarfile}"/>
    </path>

    <path id="classpath.tools">
      <fileset dir="${lib.dir}" includes="*.jar"/>
    </path>

    <!-- keyword substitutions -->
    <filterset id="filters.shared">
        <filter token="Name"          value="${Name}" />
        <filter token="website"       value="${web.site}" />
        <filter token="version-major" value="${version-major}" />
        <filter token="version-minor" value="${version-minor}" />
        <filter token="version-status" value="${version-status}" />
        <filter token="version"       value="${version}" />
    </filterset>

<!-- Main external targets -->
    <target name="main" depends="init,bin" description="Build jena.jar"/>
    <target name="release" depends="init,package"
            description="Create Jena release"/>

<!-- Section: Grammars, Compilation and JAR -->

    <target name="init">
        <tstamp/>
    </target>


    <target name="bin" depends="compile,make-jar"/>

    <target name="grammars" depends="rdql-grammar,arp-grammar"/>

    <target name="rdql-grammar">
        <jjtree target="${rdql.root}/parser/rdql.jjt"
                outputdirectory="${rdql.root}/parser"
                javacchome="${javacchome}"
                buildnodefiles="false"/>

        <javacc target="${rdql.root}/parser/rdql.jj"
                outputdirectory="${rdql.root}/parser"
                javacchome="${javacchome}"/>
    </target>


    <target name="arp-grammar"/>

    <target name="pre-compile" >
        <!-- Ensure a clean compile -->
        <delete dir="${classes.dir}"/>
        <mkdir dir="${classes.dir}"/>
    </target>

    <target name="build-src">
        <!-- Ensure clean source build -->
        <delete dir="${src.dir}"/>
        <mkdir  dir="${src.dir}"/>
    <tstamp>
        <format property="BUILD_TIME" pattern="d-MMMM-yyyy HH:mm"/>
      </tstamp>
        <copy todir="${src.dir}">
            <fileset dir="${orig-src.dir}"
                     includes="*"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/*"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/enhanced/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/graph/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/db/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/datatypes/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/mem/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/n3/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/ontology/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/rdf/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/rdql/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/reasoner/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/regression/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/shared/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/test/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/util/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/vocabulary/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="com/hp/hpl/jena/xmloutput/**"/>
            <fileset dir="${orig-src.dir}"
                     includes="jena/**"/>
            <filterset>
              <filterset refid="filters.shared" />
            <filter token="build-time"    value="${BUILD_TIME}" />
            </filterset>
        </copy>

    </target>

    <target name="compile" depends="pre-compile,build-src,compile-jena,compile-apps"/>

    <target name="compile-jena" depends="pre-compile">
        <javac srcdir="${src.dir}"
               destdir="${classes.dir}"
               debug="${debug}"
               debuglevel="${debuglevel}"
               deprecation="${deprecation}"
               optimize="${optimize}">
            <classpath refid="classpath" />
        </javac>
        <copy todir="${classes.dir}" file="${src.dir}/log4j.properties"/>
    </target>

    <target name="compile-apps" depends="pre-compile">
        <javac srcdir="${src.dir}/jena"
               destdir="${classes.dir}"
               debug="${debug}"
               deprecation="${deprecation}"
               optimize="${optimize}">
            <classpath refid="classpath" />
        </javac>
    </target>



    <target name="make-jar" depends="compile,copy-etc">
        <jar jarfile="${lib.dir}/${jarfile}"
             basedir="${classes.dir}">
        </jar>
    </target>

    <!-- copy
          + rdb configuration files
          + all data files
         into class path prior to jar step -->
    <target name="copy-etc">
        <copy todir="${classes.dir}/${etc.dir}">
        <fileset dir="${etc.dir}" includes="**"/>
         </copy>
        <copy todir="${classes.dir}">
        <fileset dir="${src.dir}" includes="**/data/**"/>
         </copy>
    </target>

<!-- Section: Javadoc -->

    <target name="javadoc" depends="build-src" description="Make the javadoc">
        <delete dir="${javadoc.dir}"/>
        <mkdir dir="${javadoc.dir}"/>

        <!-- sourcefiles="" -->
        <!-- Overview="overview.html" -->
        <!-- was: overview="src/link2readme.html" -->

        <javadoc
                 sourcepath="${src.dir}"
                 destdir="${javadoc.dir}"
                 author="true"
                 version="true"
                 classpathref="classpath"
                 windowtitle="${Name} Framework"
                 doctitle="${Name} Framework"
                 Public="true"
                 Use="true"
                 bottom="Copyright &#169; 2000-2003 Hewlett-Packard. All Rights Reserved."
                 additionalparam="-breakiterator"
         >

            <classpath refid="classpath"/>
                <package name="com.hp.hpl.jena.db"/>
                <package name="com.hp.hpl.jena.rdf.model"/>
                <package name="com.hp.hpl.jena.rdf.listeners"/>
                <package name="com.hp.hpl.jena.rdf.arp"/>
                <package name="com.hp.hpl.jena.rdf.arp.lang"/>
                <package name="com.hp.hpl.jena.rdql"/>
                <package name="com.hp.hpl.jena.vocabulary"/>
                <package name="com.hp.hpl.jena.xmloutput"/>
                <package name="com.hp.hpl.jena.ontology"/>
                <package name="com.hp.hpl.jena.ontology.daml"/>
                <package name="com.hp.hpl.jena.ontology.tidy"/>
                <package name="com.hp.hpl.jena.enhanced"/>
                <package name="com.hp.hpl.jena.graph"/>
                <package name="com.hp.hpl.jena.graph.compose"/>
                <package name="com.hp.hpl.jena.graph.query"/>
                <package name="com.hp.hpl.jena.reasoner.rulesys"/>
                <package name="com.hp.hpl.jena.reasoner.rulesys.builtins"/>
                <package name="com.hp.hpl.jena.reasoner.transitiveReasoner"/>
                <package name="com.hp.hpl.jena.reasoner"/>
                <package name="com.hp.hpl.jena.shared"/>
                <package name="com.hp.hpl.jena.datatypes"/>
                <package name="com.hp.hpl.jena.datatypes.xsd"/>
                <package name="com.hp.hpl.jena.util"/>
                <package name="com.hp.hpl.jena.util.iterator"/>
                <package name="jena"/>

            <group title="API - Application Programming Interface">
                <package name="com.hp.hpl.jena.db"/>
                <package name="com.hp.hpl.jena.rdf.model"/>
                <package name="com.hp.hpl.jena.rdf.listeners"/>
                <package name="com.hp.hpl.jena.rdf.arp"/>
                <package name="com.hp.hpl.jena.rdf.arp.lang"/>
                <package name="com.hp.hpl.jena.datatypes"/>
                <package name="com.hp.hpl.jena.datatypes.xsd"/>
                <package name="com.hp.hpl.jena.rdql"/>
                <package name="com.hp.hpl.jena.shared"/>
                <package name="com.hp.hpl.jena.vocabulary"/>
                <package name="com.hp.hpl.jena.xmloutput"/>
                <package name="com.hp.hpl.jena.ontology"/>
                <package name="com.hp.hpl.jena.ontology.daml"/>
                <package name="com.hp.hpl.jena.ontology.tidy"/>
                <package name="com.hp.hpl.jena.reasoner"/>
                <package name="com.hp.hpl.jena.reasoner.rulesys"/>
                <package name="com.hp.hpl.jena.reasoner.rulesys.builtins"/>
            </group>

            <group title="SPI - System Programming Interface">
                <package name="com.hp.hpl.jena.enhanced"/>
                <package name="com.hp.hpl.jena.graph"/>
                <package name="com.hp.hpl.jena.graph.compose"/>
                <package name="com.hp.hpl.jena.graph.query"/>
                <package name="com.hp.hpl.jena.reasoner.transitiveReasoner"/>
                <package name="com.hp.hpl.jena.util"/>
                <package name="com.hp.hpl.jena.util.iterator"/>
            </group>
            
            <group title="Command line tools">
                 <package name="jena" />
            </group>
        </javadoc>
    </target>

    <target name="javadoc-all" depends="build-src">
      <!-- This is a javadoc task to build the javadoc for developers to look at -->
        <delete dir="${javadoc.dir}"/>
        <mkdir dir="${javadoc.dir}"/>

        <javadoc
       sourcepath="${src.dir}"
       destdir="${javadoc.dir}"
       author="true"
       version="true"
             classpathref="classpath"
       windowtitle="${Name} Framework"
       doctitle="${Name} Framework"
       overview="${src.dir}/link2readme.html"
       bottom="Copyright &#169; 2000-2003 Hewlett-Packard. All Rights Reserved."
       packagenames="com.hp.hpl.*"
             additionalparam="-breakiterator"
             Use="true"
    />
    </target>


<!-- Section: Create distribution area -->

    <target name="package"
            depends="bin,javadoc,distribution-init,copy,zip"/>

    <target name="distribution-init">
        <mkdir dir="${dist.dir}"/>
    </target>

    <target name="copy" depends="distribution-init">
        <copy todir="${dist.dir}/${lib.dir}">
            <fileset dir="${lib.dir}" includes="**/*.jar"/>
            <fileset dir="${lib.dir}" includes="readme.html"/>
        </copy>


        <!-- Source : We could zip this up -->
        <copy todir="${dist.dir}/${orig-src.dir}">
            <fileset dir="${src.dir}"
                     includes="**"
                     excludes="org/**"/>
        </copy>

        <!-- Misc files -->
        <copy todir="${dist.dir}" file="build.xml"/>
        <copy todir="${dist.dir}" file="copyright.txt"/>
        <copy todir="${dist.dir}" file="ReleaseNotes.txt"/>
        <copy todir="${dist.dir}" file="test.bat"/>
        <copy todir="${dist.dir}" file="test.sh"/>
        <copy todir="${dist.dir}" file="test-db.sh"/>
        <copy todir="${dist.dir}" file="readme.html"/>

        <!-- RDQL support files : scripts to build the Java
        <copy todir="${dist.dir}" file="doExprNodes"/>
        <copy todir="${dist.dir}">
            <fileset dir="." includes="Expr*.java"/>
        </copy>
        -->

        <!-- Dependences -->

        <!-- lib directory include jena.jar -->
        <copy todir="${lib.dir}">
            <fileset dir="lib" includes="*.jar"/>
        </copy>
        <!-- Should all be in the lib directory -->

        <!-- Documentation : Try to be clear here -->
        <!-- Javadoc is part of the documentation directory -->
        <copy todir="${dist.dir}/${doc.dir}">
            <fileset dir="${doc.dir}">
              <include name="**"/>
              <exclude name="**/*.content.html"/>
              <exclude name="template.html"/>
              <!-- Scripts -->
              <exclude name="produce"/>
              <exclude name="merge"/>
              <exclude name="linkcheck"/>
              <exclude name="release"/>
              <exclude name="readme-site.txt"/>
            </fileset>
        </copy>

        <copy todir="${dist.dir}/${vocab.dir}">
            <fileset dir="${vocab.dir}" includes="**"/>
        </copy>

        <copy todir="${dist.dir}/modules">
            <fileset dir="modules" includes="**"/>
        </copy>

        <copy todir="${dist.dir}/${etc.dir}">
            <fileset dir="${etc.dir}" includes="**"/>
        </copy>

        <copy todir="${dist.dir}/${test.dir}">
            <fileset dir="${test.dir}" includes="**"/>
        </copy>

        <copy todir="${dist.dir}/${tools.dir}">
            <fileset dir="${tools.dir}" includes="**"/>
        </copy>

        <!-- Junk that creeps in -->
        <delete>
            <fileset dir="${dist.dir}" includes="**/.nbattrs"/>
        </delete>

    </target>

    <!-- Problem : seems to unpack directories to "no access" on Linux -->
    <!-- It was an ant 1.3 problem - fixed in ant 1.4 -->
    <!-- Temp fix is this external zip target -->

    <target name="zip" depends="zip-internal"/>

    <target name="zip-external" >
        <!--
             You need to have installed the WinZip
             command line interface
             http://www.winzip.com/wzcline.cgi
             obviously you need to get the path right.
        -->
       <exec dir="${dist.root}"
             output="zip.log"
             executable="C:\\Program Files\\WinZip\\wzzip.exe"  >
            <!-- ${dist.name}.zip is the name of the output -->
            <!-- ${dist.name} is the directory to zip -->
            <arg line="-r -P ${dist.name}.zip ${dist.name}"/>
       </exec>
    </target>

    <target name="zip-internal" >
        <!-- Build the zip of everything -->
        <zip zipfile="${dist.root}/${dist.name}.zip">
            <fileset dir="dist" includes="${dist.name}/**"/>
        </zip>
    </target>

    <target name="test">
        <echo>install test</echo>
        <junit fork="yes" printsummary="yes">
        <classpath>
            <fileset dir="${lib.dir}" includes="*.jar"/>
        </classpath>
        <test name="com.hp.hpl.jena.test.TestPackage"/>
      </junit>
    </target>

 <!-- uses the latest built jena code - not the jar in the lib -->
    <target name="dev-test">
        <echo>developer test</echo>
        <junit fork="yes" printsummary="yes">
        <classpath>
            <fileset dir="${lib.dir}" includes="*.jar" excludes="${jarfile}"/>
            <pathelement location="${classes.dir}"/>
        </classpath>
        <test name="com.hp.hpl.jena.test.TestPackage"/>
      </junit>
    </target>


    <target name="clean">
        <delete includeEmptyDirs="true">
            <fileset dir="${dist.dir}"/>
        </delete>
    </target>

<!-- Using schemagen to produce vocabularies -->

	<target name="vocabs" depends="ont-events, owl-vocab, ontdoc-vocab" />
	
	<target name="check.ont-events">
		<uptodate property="ont-events.build.notreq" 
		          srcFile="${vocab.dir}/ont-event.rdf" 
		          targetFile="${vocab.java}/OntEventsVocab.java" />
  	</target>

	<target name="ont-events" depends="check.ont-events" unless="ont-events.build.notreq">
		<java classname="${vocab.tool}" classpathref="classpath.tools" fork="yes">
			<arg value="-i" />
			<arg value="file:${vocab.dir}/ont-event.rdf" />
			<arg value="-c" />
			<arg value="${vocab.template}" />
			<arg value="-n" />
			<arg value="OntEventsVocab" />
			<arg value="--ontology" />
		</java>
	</target>

	<target name="check.owl-vocab">
		<uptodate property="owl-vocab.build.notreq" 
		          srcFile="${vocab.dir}/owl.owl" 
		          targetFile="${vocab.java}/OWL.java" />
  	</target>

	<target name="owl-vocab" depends="check.owl-vocab" unless="owl-vocab.build.notreq">
		<java classname="${vocab.tool}" classpathref="classpath.tools" fork="yes">
			<arg value="-i" />
			<arg value="file:${vocab.dir}/owl.owl" />
			<arg value="-c" />
			<arg value="${vocab.template}" />
			<arg value="-n" />
			<arg value="OWL" />
		</java>
	</target>

	<target name="check.ontdoc-vocab">
		<uptodate property="ontdoc-vocab.build.notreq" 
		          srcFile="${vocab.dir}/ont-manager.rdf" 
		          targetFile="${vocab.java}/OntDocManagerVocab.java" />
  	</target>

	<target name="ontdoc-vocab" depends="check.ontdoc-vocab" unless="ontdoc-vocab.build.notreq">
		<java classname="${vocab.tool}" classpathref="classpath.tools" fork="yes">
			<arg value="-i" />
			<arg value="file:${vocab.dir}/ont-manager.rdf" />
			<arg value="-c" />
			<arg value="${vocab.template}" />
			<arg value="-n" />
			<arg value="OntDocManagerVocab" />
		</java>
	</target>

</project>
